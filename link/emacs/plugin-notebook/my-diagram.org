#+title:    Diagramming Plugins/Configuration
#+author:   Tom Trabue
#+email:    tom.trabue@gmail.com
#+date:     2021:08:19
#+property: header-args:emacs-lisp :lexical t
#+tags:
#+STARTUP: fold

Here you will find various plugins for generating and interacting with diagrams,
such as UML, sequence diagrams, class relationship diagrams, etc.

* mermaid-mode
  Major mode for editing buffers written in Mermaid syntax for generating
  diagram images. Requires the =mmdc= CLI executable to be installed, which is a
  Node.js tool. Check the installation instructions for =mermaid-cli=.

** Functions

#+begin_src emacs-lisp
  (defun my/mermaid-get-bg-color ()
    "Get background color for Mermaid diagrams."
    ;; Use the main editor's default background color for Mermaid diagrams.
    (face-attribute 'default :background))

  (defun my/mermaid-determine-theme ()
    "Determine whether to use a light or dark theme for Mermaid diagrams."
    (let* ((theme "neutral")
           (bg (my/mermaid-get-bg-color))
           (luma (/ (+ (* (string-to-number (substring bg 1 2) 16) 299)
                       (* (string-to-number (substring bg 3 4) 16) 587)
                       (* (string-to-number (substring bg 5 6) 16) 114))
                    1000)))
      (print (format "luma: %d" luma))
      (if (< luma 128)
          "dark"
        "default")))
#+end_src

** use-package specification

  #+begin_src emacs-lisp
    (use-package mermaid-mode
      :mode
      ;; Associate the .mmd and .mermaid extensions with mermaid-mode.
      ("\\.mmd$" "\\.mermaid$")
      :custom
      ;; Where to find the mmdc, the mermaid command line tool.
      ;; You must have mmdc installed in order for mermaid-mode to work.
      (mermaid-mmdc-location (executable-find "mmdc"))
      ;; Should be ".png", ".pdf", or ".svg"
      (mermaid-output-format ".png")
      ;; Extra CLI flags to pass to mmdc.
      (mermaid-flags (concat "-t " (my/mermaid-determine-theme)
                             " -b " (my/mermaid-get-bg-color))))
  #+end_src
