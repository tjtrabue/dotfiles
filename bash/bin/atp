#!/usr/bin/env bash

set -e

################################################################################
##                                                                            ##
##                             Supporting Functions                           ##
##                                                                            ##
################################################################################

function shortpath () {
    local input_path="$1";
    egrep "^\s*export" "$DIR_ALIAS_FILE" | sed 's/^ *export *//' | sed 's/=.*//' | {
        local var best_var to_replace best_to_replace;
        while read -s var; do
            local dir_alias="$(env | egrep "^${var}\b")";
            if [[ -n $dir_alias ]]; then
                to_replace="$(echo "$dir_alias" | sed -e "s/${var}=//" -e 's/"//g')";
                if [[ "$input_path" =~ ^"${to_replace%/}/".* ]]; then
                    if [[ ${#to_replace} -gt ${#best_to_replace} ]]; then
                        best_to_replace="$to_replace";
                        best_var="$var";
                    fi;
                fi;
            fi;
        done;
        if [[ -n $best_to_replace ]]; then
            input_path="$(echo "$input_path" | sed "s:$best_to_replace:\\$$best_var:")";
        fi;
        echo "$input_path"
    }
}

# Used for printing errors:
function echoe () { echo -e "${RED}ERROR${NC}: $@" 1>&2 ; }

# Used for printing warnings:
function echow () { echo -e "${BROWN_ORANGE}WARNING${NC}: $@" 1>&2 ; }


################################################################################
##                                                                            ##
##                                  Variables                                 ##
##                                                                            ##
################################################################################

# The path to add to the .path file
to_add=$(shortpath "$(pwd)");

################################################################################
##                                                                            ##
##                                 Main Program                               ##
##                                                                            ##
################################################################################

# Adds a directory to the PATH environment variable.
# By default adds the working directory, but can take
# an argument as well
if [[ "$#" -eq 1 ]]; then
    to_add="$1" && to_add=$(shortpath "$to_add");
fi

grep --color=never -ho "^export\ PATH=\$PATH:$to_add" ~/.path >> /dev/null

if [ $? -ne 0 ]; then
    PATH=$PATH:$to_add
    sed -i "s|^export\ PATH=\$PATH:$to_add||g" ~/.path
    sed -i "/^$/d" ~/.path
    perl -pi -e 'chomp if eof' ~/.path && echo >> ~/.path
    echo -n "\"export PATH=\$PATH:$to_add\"" >> ~/.path
    source ~/.path
    src
else
    exit 1
fi