#!/usr/bin/env bash

set -e

################################################################################
##                                                                            ##
##                             Supporting Functions                           ##
##                                                                            ##
################################################################################

# Takes care of any final operations
function cleanup() {
    local f
    for f in ~/.{dirs,vars,path}; do
        source "$f"
    done
}
trap cleanup EXIT

# Used for printing errors:
function echoe () { echo -e "${RED}ERROR${NC}: $@" 1>&2 ; }

# Used for printing warnings:
function echow () { echo -e "${BROWN_ORANGE}WARNING${NC}: $@" 1>&2 ; }


################################################################################
##                                                                            ##
##                                  Variables                                 ##
##                                                                            ##
################################################################################

# The path to add to the .path file
to_add=$(shortpath "$(pwd)");

################################################################################
##                                                                            ##
##                                 Main Program                               ##
##                                                                            ##
################################################################################

# Adds a directory to the PATH environment variable.
# By default adds the working directory, but can take
# an argument as well
if [[ "$#" -eq 1 ]]; then
    to_add="$1" && to_add=$(shortpath "$to_add");
fi

grep --color=never -ho "^export\ PATH=\$PATH:$to_add" ~/.path >> /dev/null

if [ $? -ne 0 ]; then
    PATH=$PATH:$to_add
    sed -i "s|^export\ PATH=\$PATH:$to_add||g" ~/.path
    sed -i "/^$/d" ~/.path
    perl -pi -e 'chomp if eof' ~/.path && echo >> ~/.path
    echo -n "\"export PATH=\$PATH:$to_add\"" >> ~/.path
    source ~/.path
    src
else
    exit 1
fi