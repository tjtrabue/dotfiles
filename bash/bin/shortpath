#!/usr/bin/env bash

################################################################################
##                                                                            ##
##                             Supporting Functions                           ##
##                                                                            ##
################################################################################

# Source all required files into the executable environment
function setup() {
    local f
    for f in ~/.{dirs,vars,path}; do
        . "$f"
    done
}

# Ensure that .dirs file exists and is referenced by DIR_ALIAS_FILE:
function set_dirs_file() {
    if [[ ! -f ~/.dirs ]]; then
        touch ~/.dirs
    fi

    if [[ -z "$DIR_ALIAS_FILE" ]]; then
        DIR_ALIAS_FILE=~/.dirs
        echo "DIR_ALIAS_FILE=~/.dirs" >> ~/.vars
        export DIR_ALIAS_FILE
    fi
}

################################################################################
##                                                                            ##
##                                  Variables                                 ##
##                                                                            ##
################################################################################

declare input_path="$1";
declare dir_alias;
declare var;
declare best_var;
declare to_replace;
declare best_to_replace;

################################################################################
##                                                                            ##
##                                 Main Program                               ##
##                                                                            ##
################################################################################

setup
set_dirs_file

input_path="$1";
egrep "^\s*export" "$DIR_ALIAS_FILE" | sed 's:^ *export *::' | sed 's:=.*::' | {
    while read -s var; do
        dir_alias="`env | egrep "^${var}\b"`";
        if [[ -n $dir_alias ]]; then
            to_replace="`echo "$dir_alias" | sed -e "s:${var}=::" -e 's:"::g'`";
            if [[ "$input_path" =~ ^"${to_replace%/}/".* ]]; then
                if [[ ${#to_replace} -gt ${#best_to_replace} ]]; then
                    best_to_replace="$to_replace";
                    best_var="$var";
                fi;
            fi;
        fi;
    done;
    if [[ -n $best_to_replace ]]; then
        input_path="`echo "$input_path" | sed "s:$best_to_replace:\\$$best_var:"`";
    fi;
    echo "$input_path"
}