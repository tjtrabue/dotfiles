#!/usr/bin/env bash

################################################################################
##                                                                            ##
##                               Usage Functions                              ##
##                                                                            ##
################################################################################

# Full help message
function _matrix_menu_help() {
    echo "A two-dimensional selection menu that the user can navigate" 1>&2
    echo "with the arrow keys. Note that this is NOT the binary that should" 1>&2
    echo "be called by the end user. They should use matrix_menu instead," 1>&2
    echo "which is used the exact same way." 1>&2
    _matrix_menu_usage
}

# Usage message
function _matrix_menu_usage() {
    echo "Usage:" 1>&2
    echo "This binary is used by calling _matrix_menu and one or more --row (or -r) flags with the data" 1>&2
    echo "for each row after each flag:" 1>&2
    echo "    _matrix_menu --row [row1_option1 [row1_option2 ...] --row [row2_option1 ...]]" 1>&2
    echo "    _matrix_menu -r [row1_option1 [row1_option2 ...] -r [row2_option1 ...]]" 1>&2
    echo "Options:" 1>&2
    echo "    --help | -h" 1>&2
    echo "Print the help message" 1>&2
}

################################################################################
##                                                                            ##
##                               Exit Functions                               ##
##                                                                            ##
################################################################################

# Exit the program if the user requests the help message:
function exit_if_help_requested () {
    if [[ "$1" == "-h" || "$1" == "--help" ]]; then
        _matrix_menu_help
        exit 0
    fi
}

# Exit the program if the user enters input incorrectly
function exit_if_input_incorrect () {
    if [[ "$#" -eq 0 ]]; then
        echoe "Need one or more rows of data"
        _matrix_menu_usage
    fi
}

################################################################################
##                                                                            ##
##                             Supporting Functions                           ##
##                                                                            ##
################################################################################

# Parse the user's input, determine the number of rows and columns, and
# initialize the matrix with the user's data
function parse_input_and_init_matrix() {
    local input="$@"
    local token
    local current_row=0
    local current_column=0
    for token in $input; do
        if [[ "$token" == "-r" || "$token" == "--row" ]]; then
            (( num_rows+=1 ))
            (( current_row+=1 ))
            current_column=0
        else
            (( current_column+=1 ))
            if [[ "$current_column" -gt "$num_columns" ]]; then
                (( num_columns+=1 ))
            fi
            matrix[$current_row,$current_column]="$token"
        fi
    done
}

# Initialize the display style variables
function init_display_vars() {
    f1="%$((${#num_rows}+1))s"
    f2=" %9s"
}

# Print the 2D matrix menu:
function print_menu() {
    local i j
    for (( j = 1; j <= num_rows; j++ )) do
        for (( i = 1; i <= num_columns; i++ )) do
            if [[ $cursor_x == "$i" && $cursor_y == "$j" ]]; then
                echo -n "$color_reverse"
            else
                echo -n "$color_normal"
            fi
            eval "printf \"$f2\" \${matrix[$j,$i]}"
        done
        echo 1>&2
    done
}

# Get user key input and call the appropriate private function:
function get_user_input() {
    local key
    read -rsn 1 key

    case $key in
        "q")
            end=true
            ;;
    esac
}

# Used for printing errors:
function echoe () { echo -e "${RED}ERROR${NC}: $@" 1>&2 ; }

# Used for printing warnings:
function echow () { echo -e "${BROWN_ORANGE}WARNING${NC}: $@" 1>&2 ; }

################################################################################
##                                                                            ##
#                                Test Functions                               ##
##                                                                            ##
################################################################################

# Print the variable values
function print_variables() {
    echo "end: $end" 1>&2
    echo "rum_rows: $num_rows" 1>&2
    echo "num_columns: $num_columns" 1>&2

    local i j
    echo -e "\nMenu:" 1>&2
    printf "$f1" ''
    for ((i=1; i<=num_columns; i++)) do
        printf "$f2" $i
    done
    echo

    for ((j=1; j<=num_rows; j++)) do
        printf "$f1" $j
        for ((i=1; i<=num_columns; i++)) do
            printf "$f2" ${matrix[$j,$i]}
        done
        echo
    done
}

################################################################################
##                                                                            ##
##                                  Variables                                 ##
##                                                                            ##
################################################################################

# Indicates when the program should end
declare end=false

# The associative array that will hold the rows of options
declare -A matrix

# The number of rows in the two-dimensinoal menu
declare num_rows=0

# The number of columns in the two-dimensional menu
declare num_columns=0

# Display variables
declare f1
declare f2

# The position of the highlighted option at any given time
declare cursor_x=1
declare cursor_y=1

# Aliases for the arrow keys
declare arrow_up="$(echo -e '\e[A')"
declare arrow_down="$(echo -e '\e[B')"
declare arrow_right="$(echo -e '\e[C')"
declare arrow_left="$(echo -e '\e[D')"

# Aliases for escape and newline keys
declare escape="$(echo -e '\e')"
declare newline="$(echo -e '\n')"

# Set color variables
declare color_normal="$(echo -e '\r\e[0;1m')"
declare color_reverse="$(echo -e '\r\e[1;7m')"

################################################################################
##                                                                            ##
##                                 Main Program                               ##
##                                                                            ##
################################################################################

# Figure out option rows based on user input
parse_input_and_init_matrix "$@"

# Initialize the variables used to format the rows/columns of the menu
init_display_vars

# Begin main program loop:
while ! $end; do
    print_menu
    get_user_input
done # End main program loop