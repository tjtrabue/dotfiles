#!/usr/bin/env bash

# Emacs installer script.
#
# All of the functions in this file are prefixed with "ie" to show they are
# privately namespaced to this script, and thus should not conflict with
# functions defined in other parts of my dotfiles repository.

set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

# Variables {{{
declare THIS_EXEC="$(basename "${BASH_SOURCE[0]}")"
declare DOTFILES_REPO="${HOME}/.dotfiles"
declare WS

# Build options
declare INSTALL_PREFIX="/usr/local"
declare USE_PGTK=false

# Emacs location variables
declare EMACS_GIT_URL="https://github.com/emacs-mirror/emacs.git"
declare EMACS_DEST="${WS}/emacs"
declare EMACS_BACKUP="${EMACS_DEST}.bak"
# }}}

# Logging variables {{{
declare LOG_TO_FILE=""
declare LOG_LEVEL=3
# }}}

# Imports {{{
. "${DOTFILES_REPO}/shell/common/source/common.sh" && src
# }}}

# Functions {{{
_help() {
  command cat <<EOF
${THIS_EXEC}

Install Emacs from its master branch.

You will need to install lots of build dependencies, and unfortunately the list
changes pretty drastically depending on your OS. Some generic advice for
building Emacs from source:

- Make sure you have libgccjit installed, and make sure its version matches
  your GCC version. Otherwise, the configure step will fail.

If installing on Windows for WSL, see the following page for instructions:
  https://github.com/hubisan/emacs-wsl

As well as the following article on using Linux GUI apps on Windows:
  https://learn.microsoft.com/en-us/windows/wsl/tutorials/gui-apps

USAGE:
  ${THIS_EXEC} [OPTIONS]

OPTIONS:
  -h | --help
    Print the help message (this message) and exit.

  --prefix=PREFIX_DIR
    Install all Emacs files under prefix directory PREFIX_DIR. PREFIX_DIR
    defaults to '/usr/local', meaning that this script will install Emacs files
    to '/usr/local/bin', '/usr/local/lib', etc.

  -p | --pgtk
    Compile Emacs with Pure GTK support. This is not recommended if you will be
    running Emacs in an X Windows session. Pure GTK works well for Weyland, and
    for Emacs running as part of WSL on Windows.
EOF
}

# Setup/Cleanup Functions {{{
ie__set_global_vars() {
  log_info "Settings global variables"
  WS="${WS:-${HOME}/workspace}"
}

ie__make_dirs() {
  log_info "Creating necessary directories"
  mkdir -p "${WS}"
}

ie__setup() {
  ie__set_global_vars
  ie__make_dirs
}

# We should only remove the Emacs backup repository if the installation
# succeeded.
ie__remove_emacs_backup_repository() {
  if [ -d "${EMACS_BACKUP}" ]; then
    log_info "Removing Emacs backup repository"
    rm -rf "${EMACS_BACKUP}"
  fi
}

# Make a backup of the emacs repository before we uninstall anything, just so
# we'll have a backup to work from if something goes wrong.
ie__backup_emacs_repository() {
  log_info "Backing up Emacs repository"
  cp -rf "${EMACS_DEST}" "${EMACS_BACKUP}"
}

# Delete an existing Emacs installation built from source.
ie__uninstall_old_emacs_installation() {
  if [ -d "${EMACS_DEST}" ]; then
    log_info "Removing old Emacs installation at: ${BLUE}${EMACS_DEST}${NC}"
    (
      cd "${EMACS_DEST}" &&
        sudo make uninstall
    )
  fi
}
# }}}

# OS-specific options {{{
ie__linux_build_options() {
  log_info "Adding Linux build options"
  printf '%s' '--with-x-toolkit=gtk3'
}

ie__mac_build_options() {
  log_info "Adding macOS build options"
  printf '%s' '--with-ns'
}
# }}}

ie__confirm_installation() {
  local configureCmd="${1}"
  local response=""

  while ! printf '%s' "${response}" | grep -q '[YyNn]'; do
    command cat <<EOF
Installing Emacs using the following configuration:

$(printf '%s' "${configureCmd}" | sed -E 's/\s+/\n  /g')

Continue? [y/n]
EOF
    read -r response
  done

  printf '%s' "${response}" | grep -q '[Yy]'
}

# Install emacs from source. This option is pretty hard to make portable, but
# I've done the best I can. You will need a lot of dependencies, and their names
# will change depending on you OS. Check my ubuntu_packages.txt and
# arch_packages.txt files to get a good idea of what you'll need.
ie__install_from_source() {
  local osType="$(getostype)"
  local configureCmd="./configure \
    --prefix=${INSTALL_PREFIX} \
    --enable-year2038 \
    --without-compress-install \
    --with-json \
    --with-tree-sitter \
    --with-xwidgets \
    --with-imagemagick \
    --with-native-compilation=aot"

  # Add OS-specific build options to the configure command.
  case "${osType}" in
  "Linux")
    configureCmd="${configureCmd} $(ie__linux_build_options)"
    ;;
  "Darwin")
    configureCmd="${configureCmd} $(ie__mac_build_options)"
    ;;
  esac

  if "${USE_PGTK}"; then
    configureCmd="${configureCmd} --with-pgtk"
  elif [ "${osType}" = "Linux" ]; then
    # If we're on Linux and not using PGTK, we should fall back on the X Window
    # System.
    configureCmd="${configureCmd} --with-x"
  fi

  if ! ie__confirm_installation "${configureCmd}"; then
    err "Installation terminated by user."
    return 1
  fi

  if [ -d "${EMACS_DEST}" ]; then
    ie__backup_emacs_repository
    ie__uninstall_old_emacs_installation
  fi

  log_info "Cloning/Updating Emacs Git Repo"
  clone_or_update_git_repo "${EMACS_GIT_URL}" "${EMACS_DEST}"
  (
    log_info "Installing latest Emacs" &&
      cd "${EMACS_DEST}" &&
      export CC="gcc" CXX="g++" &&
      ./autogen.sh &&
      eval "${configureCmd}" &&
      make -j"$(nproc)" trampolines &&
      sudo make install
  ) &&
    ie__remove_emacs_backup_repository
}

main() {
  print_header "Installing Emacs (the best editor!)"
  ie__setup
  ie__install_from_source
}
# }}}

# Parse CLI Options {{{
args=$(getopt -o hp --long help,pgtk,prefix: -n 'install_emacs' -- "$@")
eval set -- "$args"

# extract options and their arguments into variables.
while true; do
  case "$1" in
  -h | --help)
    _help
    exit 0
    ;;

  -p | --pgtk)
    log_info "Building with Pure GTK support"
    USE_PGTK=true
    shift
    ;;

  --prefix)
    case "$2" in
    "")
      shift 2
      ;;
    *)
      INSTALL_PREFIX="$2"
      shift 2
      ;;
    esac
    ;;

  --)
    shift
    break
    ;;

  *)
    err "Unknown option $1 to ${THIS_EXEC}"
    exit 2
    ;;
  esac
done
# }}}

main "${@}"

# vim:foldenable:foldmethod=marker: